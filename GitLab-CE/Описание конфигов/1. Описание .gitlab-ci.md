## 1) Что делает пайплайн

1. **test** — прогоняет `pytest` в `python:3.12`, кеширует `pip` (быстрее сборки).
2. **docker-test** — собирает Docker-образ из репозитория, поднимает временный контейнер и **проверяет доступность** приложения `curl`-ом по HTTP внутри тестовой сети Docker.
3. **deploy** — при пуше в `main` подключается по SSH к VDS и выполняет деплой через `git pull` + `bash deploy.sh`.

## 2) Технологии и подходы

* **GitLab CI**: stages → `test`, `docker-test`, `deploy`.
* **Кеширование pip**: `PIP_CACHE_DIR` + `cache.paths`.
* **Docker проверка «как в жизни»**: отдельная тестовая сеть `ci-test-net`, health-пинг через `curlimages/curl`.
* **SSH-деплой**: подготовка ключа (CRLF→LF, права, known\_hosts), пробный `ssh -vvv`.
* **Теги Runner’а**: `tags: [flask]` — осознанная привязка к нужному раннеру.

## 3) Переменные окружения (GitLab → Settings → CI/CD → Variables)

* `VDS_HOST` — хост (например, `1.2.3.4`).
* `VDS_USER` — пользователь на сервере (например, `ubuntu`).
* `VDS_KEY` — **Private Key** (лучше как *File variable*), используется для SSH.
* *(опционально)* `CI_REGISTRY`, `CI_REGISTRY_IMAGE` — если позже добавлю пуш образов.

## 4) Предпосылки/ожидания окружения

* На Runner’е для `docker-test` доступен Docker-демон по `unix:///var/run/docker.sock`
  (shell-runner с установленным Docker **или** privileged Docker-runner).
* На VDS уже инициализирован проект (папка `~/flask-ci-demo`) и есть `deploy.sh`.
* Приложение слушает порт `8080` внутри контейнера (curl стучится туда).

## 5) Как это работает по шагам

1. **`test`**

   * Устанавливает зависимости из `requirements.txt`.
   * Добавляет корень проекта в `PYTHONPATH`.
   * Запускает `pytest`.
2. **`docker-test`**

   * `docker build -t flask-ci-demo:test .`
   * Создаёт сеть `ci-test-net` (idempotent).
   * Запускает контейнер `flask-test`.
   * Ждёт 5 сек и проверяет `curl -f http://flask-test:8080` из отдельного контейнера.
   * Если сервис не отвечает — показывает `docker logs` и падает.
3. **`deploy`** *(только в `main`)*

   * Готовит `~/.ssh/id_ed25519` из `VDS_KEY` (чистит CRLF, права, known\_hosts).
   * Делает пробный `ssh -vvv` (диагностика ключа/доступа).
   * На сервере: `cd ~/flask-ci-demo && git pull --ff-only && bash deploy.sh`.
